<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monkey Tower Defense</title>

<style>
body {
  margin: 0;
  background: #0f130c;
  color: #eee;
  font-family: Arial, Helvetica, sans-serif;
  text-align: center;
}

#ui {
  background: #1c2416;
  padding: 10px;
}

button {
  background: #3a4a2b;
  color: #eee;
  border: 1px solid #6b8e23;
  padding: 8px;
  margin: 3px;
  cursor: pointer;
}

button:hover {
  background: #556b2f;
}

#upgradePanel {
  display: none;
  margin-top: 6px;
}

canvas {
  display: block;
  margin: auto;
  background: #2a3720;
  border: 2px solid #5a7d2b;
}
</style>
</head>

<body>

<div id="ui">
  ‚ù§Ô∏è <span id="lives">20</span>
  üçå <span id="bananas">150</span>
  üåä Wave <span id="wave">0</span><br>

  <button onclick="startWave()">Start Wave</button>
  <button onclick="startPlacing()">Place Monkey (üçå50)</button>

  <div id="upgradePanel">
    <button onclick="upgrade('damage')">Damage üçå30</button>
    <button onclick="upgrade('range')">Range üçå30</button>
    <button onclick="upgrade('fireRate')">Speed üçå30</button>
  </div>
</div>

<canvas id="game" width="800" height="500"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let lives = 20;
let bananas = 150;
let wave = 0;
let placingTower = false;
let ghostPos = {x:0,y:0};
let selectedTower = null;
let gameEnded = false;
let shake = 0;

const path = [
  {x:0,y:250},{x:200,y:250},{x:200,y:100},
  {x:500,y:100},{x:500,y:400},{x:800,y:400}
];

const enemies=[], towers=[], bullets=[];

// ---------- GORILLA ----------
class Enemy {
  constructor() {
    this.x = path[0].x;
    this.y = path[0].y;
    this.hp = 60 + wave * 12;
    this.maxHp = this.hp;
    this.speed = 1 + wave * 0.03;
    this.i = 0;
    this.size = 12 + Math.random()*4;
  }

  update() {
    const t = path[this.i+1];
    if (!t) { lives--; return false; }
    const dx=t.x-this.x, dy=t.y-this.y;
    const d=Math.hypot(dx,dy);
    if (d < this.speed) this.i++;
    else {
      this.x+=dx/d*this.speed;
      this.y+=dy/d*this.speed;
    }
    return true;
  }

  draw() {
    ctx.fillStyle="#3b3b3b";
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="red";
    ctx.beginPath();
    ctx.arc(this.x-4,this.y-3,2,0,Math.PI*2);
    ctx.arc(this.x+4,this.y-3,2,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="lime";
    ctx.fillRect(this.x-16,this.y-22,(this.hp/this.maxHp)*32,4);
  }
}

// ---------- MONKEY ----------
class Tower {
  constructor(x,y){
    this.x=x; this.y=y;
    this.range=160;
    this.fireRate=28;
    this.cooldown=0;
    this.damage=22;
    this.recoil=0;
  }

  update(){
    if(this.cooldown>0){this.cooldown--;return;}
    const target=enemies.find(e=>Math.hypot(e.x-this.x,e.y-this.y)<=this.range);
    if(target){
      bullets.push(new Bullet(this,target));
      this.cooldown=this.fireRate;
      this.recoil=4;
    }
  }

  draw(ghost=false){
    if(this.recoil>0) this.recoil--;

    ctx.globalAlpha = ghost ? 0.5 : 1;

    ctx.fillStyle="#8b5a2b";
    ctx.beginPath();
    ctx.arc(this.x-14,this.y,6,0,Math.PI*2);
    ctx.arc(this.x+14,this.y,6,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle=this===selectedTower?"#ffd700":"#a0522d";
    ctx.beginPath();
    ctx.arc(this.x,this.y,15-this.recoil,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="black";
    ctx.beginPath();
    ctx.arc(this.x-4,this.y-3,2,0,Math.PI*2);
    ctx.arc(this.x+4,this.y-3,2,0,Math.PI*2);
    ctx.fill();

    ctx.globalAlpha = 1;
  }
}

// ---------- BANANA ----------
class Bullet{
  constructor(t,e){
    this.x=t.x; this.y=t.y;
    this.e=e;
    this.speed=6;
    this.dmg=t.damage;
  }

  update(){
    const dx=this.e.x-this.x, dy=this.e.y-this.y;
    const d=Math.hypot(dx,dy);
    if(d<6){
      this.e.hp-=this.dmg;
      shake=6;
      return false;
    }
    this.x+=dx/d*this.speed;
    this.y+=dy/d*this.speed;
    return true;
  }

  draw(){
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.ellipse(this.x,this.y,4,2,0,0,Math.PI*2);
    ctx.fill();
  }
}

// ---------- PLACEMENT ----------
function startPlacing(){
  if(bananas<50 || gameEnded) return;
  placingTower = true;
}

canvas.addEventListener("mousemove", e=>{
  const r=canvas.getBoundingClientRect();
  ghostPos.x=e.clientX-r.left;
  ghostPos.y=e.clientY-r.top;
});

canvas.addEventListener("contextmenu", e=>{
  e.preventDefault();
  placingTower=false;
});

canvas.onclick=e=>{
  if(gameEnded){ resetGame(); return; }

  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;

  selectedTower=null;
  document.getElementById("upgradePanel").style.display="none";

  for(const t of towers){
    if(Math.hypot(t.x-x,t.y-y)<15){
      selectedTower=t;
      document.getElementById("upgradePanel").style.display="block";
      return;
    }
  }

  if(placingTower && bananas>=50){
    towers.push(new Tower(ghostPos.x,ghostPos.y));
    bananas-=50;
    placingTower=false;
  }
};

// ---------- GAME ----------
function startWave(){
  if(gameEnded) return;
  wave++;
  for(let i=0;i<8+wave*2;i++){
    setTimeout(()=>enemies.push(new Enemy()),i*450);
  }
}

function upgrade(type){
  if(!selectedTower||bananas<30) return;
  bananas-=30;
  if(type==="damage") selectedTower.damage+=8;
  if(type==="range") selectedTower.range+=20;
  if(type==="fireRate") selectedTower.fireRate=Math.max(10,selectedTower.fireRate-4);
}

function drawPath(){
  ctx.strokeStyle="#6b8e23";
  ctx.lineWidth=30;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  path.forEach(p=>ctx.lineTo(p.x,p.y));
  ctx.stroke();
}

function gameOverScreen(){
  ctx.fillStyle="rgba(0,0,0,0.7)";
  ctx.fillRect(0,0,800,500);
  ctx.fillStyle="#ff5555";
  ctx.font="48px Arial";
  ctx.textAlign="center";
  ctx.fillText("GAME OVER",400,200);
  ctx.fillStyle="white";
  ctx.font="22px Arial";
  ctx.fillText(`You reached wave ${wave}`,400,245);
  ctx.fillText("Click to Retry",400,300);
}

function resetGame(){
  enemies.length=0; towers.length=0; bullets.length=0;
  lives=20; bananas=150; wave=0; gameEnded=false;
}

function loop(){
  if(gameEnded){ gameOverScreen(); return; }

  ctx.save();
  if(shake>0){
    ctx.translate((Math.random()-0.5)*shake,(Math.random()-0.5)*shake);
    shake--;
  }

  ctx.clearRect(0,0,800,500);
  drawPath();

  towers.forEach(t=>{t.update();t.draw();});

  // ghost monkey + range
  if(placingTower){
    ctx.strokeStyle="rgba(255,255,255,0.25)";
    ctx.beginPath();
    ctx.arc(ghostPos.x,ghostPos.y,160,0,Math.PI*2);
    ctx.stroke();
    new Tower(ghostPos.x,ghostPos.y).draw(true);
  }

  for(let i=enemies.length-1;i>=0;i--){
    if(!enemies[i].update()){enemies.splice(i,1);continue;}
    if(enemies[i].hp<=0){bananas+=15;shake=8;enemies.splice(i,1);}
    else enemies[i].draw();
  }

  for(let i=bullets.length-1;i>=0;i--){
    if(!bullets[i].update()) bullets.splice(i,1);
    else bullets[i].draw();
  }

  ctx.restore();

  document.getElementById("lives").textContent=lives;
  document.getElementById("bananas").textContent=bananas;
  document.getElementById("wave").textContent=wave;

  if(lives<=0) gameEnded=true;

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
