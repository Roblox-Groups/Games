<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Monkey Defense</title>
<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:#0f160c;
  font-family:Arial;
}
#ui{
  position:fixed;
  top:10px;
  left:10px;
  background:rgba(30,40,20,.9);
  color:#fff;
  padding:10px;
  border-radius:8px;
}
button{
  margin:3px;
  padding:6px 10px;
  background:#4b5d2a;
  color:#fff;
  border:1px solid #8bbf55;
  cursor:pointer;
}
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75);
  color:#fff;
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
</style>
</head>
<body>

<div id="ui">
‚ù§Ô∏è <span id="lives">20</span>
üçå <span id="bananas">250</span>
üåä <span id="wave">0</span><br>
<button onclick="selectTower('dart')">Dart üêµ (50)</button>
<button onclick="selectTower('sniper')">Sniper üéØ (90)</button>
<button onclick="selectTower('water')">Water ü¶¶ (80)</button><br>
<button onclick="startWave()">Start Wave</button>
</div>

<div id="overlay">
  <h1 id="overlayText"></h1>
  <button onclick="restart()">Retry</button>
</div>

<canvas id="game"></canvas>

<script>
/* ========= CANVAS ========= */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
function resize(){
 canvas.width=innerWidth;
 canvas.height=innerHeight;
}
window.onresize=resize; resize();

/* ========= GAME STATE ========= */
let lives=20, bananas=250, wave=0;
let placing=null, gameOver=false;
const towers=[], enemies=[], bullets=[], particles=[];

/* ========= MAP ========= */
const lake={x:canvas.width*0.65,y:canvas.height*0.6,r:120};
const bushes=[
 {x:300,y:300,r:40},
 {x:500,y:200,r:35}
];
const path=[
 {x:-50,y:canvas.height/2},
 {x:300,y:canvas.height/2},
 {x:300,y:150},
 {x:700,y:150},
 {x:700,y:canvas.height-100},
 {x:canvas.width+50,y:canvas.height-100}
];

/* ========= CLASSES ========= */
class Enemy{
 constructor(){
  this.x=path[0].x; this.y=path[0].y;
  this.i=0; this.hp=80+wave*15; this.max=this.hp;
  this.spd=1+wave*0.08;
 }
 update(){
  const t=path[this.i+1];
  if(!t){lives--; return false;}
  const dx=t.x-this.x,dy=t.y-this.y,d=Math.hypot(dx,dy);
  if(d<this.spd) this.i++;
  else{this.x+=dx/d*this.spd; this.y+=dy/d*this.spd;}
  return true;
 }
 draw(){
  ctx.fillStyle="#444";
  ctx.beginPath();ctx.arc(this.x,this.y,16,0,6.28);ctx.fill();
  ctx.fillStyle="red";
  ctx.fillRect(this.x-16,this.y-26,(this.hp/this.max)*32,4);
 }
}

class Tower{
 constructor(x,y,type){
  this.x=x;this.y=y;this.type=type;
  if(type==="dart"){this.range=140;this.rate=25;this.dmg=20;}
  if(type==="sniper"){this.range=320;this.rate=70;this.dmg=60;}
  if(type==="water"){this.range=160;this.rate=40;this.dmg=18;}
  this.cd=0;
 }
 update(){
  if(this.cd>0){this.cd--;return;}
  const e=enemies.find(e=>Math.hypot(e.x-this.x,e.y-this.y)<=this.range);
  if(e){
   bullets.push({x:this.x,y:this.y,e,d:this.dmg});
   this.cd=this.rate;
  }
 }
 draw(){
  ctx.fillStyle=this.type==="sniper"?"#999":
                this.type==="water"?"#2fa4ff":"#a56b2a";
  ctx.beginPath();ctx.arc(this.x,this.y,16,0,6.28);ctx.fill();
 }
}

/* ========= HELPERS ========= */
function onPath(x,y){
 for(let i=0;i<path.length-1;i++){
  const a=path[i],b=path[i+1];
  const d=Math.abs((b.y-a.y)*x-(b.x-a.x)*y+b.x*a.y-b.y*a.x)/
          Math.hypot(b.y-a.y,b.x-a.x);
  if(d<25) return true;
 }
 return false;
}
function inLake(x,y){return Math.hypot(x-lake.x,y-lake.y)<lake.r;}
function inBush(x,y){return bushes.some(b=>Math.hypot(x-b.x,y-b.y)<b.r);}

/* ========= INPUT ========= */
canvas.onclick=e=>{
 if(gameOver) return;
 if(!placing) return;
 const x=e.clientX,y=e.clientY;

 if(placing==="water"&&!inLake(x,y))return;
 if(placing!=="water"&&inLake(x,y))return;
 if(onPath(x,y)||inBush(x,y))return;

 const cost=placing==="dart"?50:placing==="sniper"?90:80;
 if(bananas<cost)return;

 towers.push(new Tower(x,y,placing));
 bananas-=cost;
 placing=null;
};

function selectTower(t){placing=t;}

function startWave(){
 if(enemies.length||gameOver)return;
 wave++;
 for(let i=0;i<6+wave*2;i++)
  setTimeout(()=>enemies.push(new Enemy()),i*500);
}

/* ========= GAME LOOP ========= */
function drawMap(){
 ctx.fillStyle="#2f4f1e";
 ctx.fillRect(0,0,canvas.width,canvas.height);

 // lake
 ctx.fillStyle="#2fa4ff";
 ctx.beginPath();ctx.arc(lake.x,lake.y,lake.r,0,6.28);ctx.fill();

 // bushes
 ctx.fillStyle="#1f6b1f";
 bushes.forEach(b=>{
  ctx.beginPath();ctx.arc(b.x,b.y,b.r,0,6.28);ctx.fill();
 });

 // path
 ctx.strokeStyle="#7b8b3a";
 ctx.lineWidth=40;
 ctx.beginPath();
 ctx.moveTo(path[0].x,path[0].y);
 path.forEach(p=>ctx.lineTo(p.x,p.y));
 ctx.stroke();
}

function loop(){
 ctx.clearRect(0,0,canvas.width,canvas.height);
 drawMap();

 towers.forEach(t=>{t.update();t.draw();});

 if(placing){
  ctx.strokeStyle="rgba(255,255,255,.4)";
  ctx.beginPath();
  ctx.arc(mouseX,mouseY,
    placing==="sniper"?320:placing==="water"?160:140,
    0,6.28);
  ctx.stroke();
 }

 for(let i=enemies.length-1;i>=0;i--){
  if(!enemies[i].update()){enemies.splice(i,1);continue;}
  enemies[i].draw();
  if(enemies[i].hp<=0){
   bananas+=15;
   enemies.splice(i,1);
  }
 }

 for(let i=bullets.length-1;i>=0;i--){
  const b=bullets[i];
  const dx=b.e.x-b.x,dy=b.e.y-b.y,d=Math.hypot(dx,dy);
  if(d<6){
   b.e.hp-=b.d;
   bullets.splice(i,1);
   continue;
  }
  b.x+=dx/d*7;b.y+=dy/d*7;
  ctx.fillStyle="yellow";
  ctx.beginPath();ctx.arc(b.x,b.y,3,0,6.28);ctx.fill();
 }

 if(lives<=0){
  gameOver=true;
  document.getElementById("overlayText").textContent="Game Over";
  document.getElementById("overlay").style.display="flex";
 }

 document.getElementById("lives").textContent=lives;
 document.getElementById("bananas").textContent=bananas;
 document.getElementById("wave").textContent=wave;

 requestAnimationFrame(loop);
}
let mouseX=0,mouseY=0;
canvas.onmousemove=e=>{mouseX=e.clientX;mouseY=e.clientY;};

function restart(){location.reload();}

loop();
</script>
</body>
</html>
